<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像生成模型训练平台</title>
    <script>
        window.ELEMENT_PLUS_DEVTOOLS = false;
    </script>
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css">
    <script src="//unpkg.com/vue@3"></script>
    <script src="//unpkg.com/element-plus"></script>
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3254019_f9ym4v0dji.css">
    <script src="//unpkg.com/@element-plus/icons-vue"></script>
    <style>
        :root {
            --primary-color: #409EFF;
            --background-color: #f5f7fa;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: #2c3e50;
        }

        .app-container {
            min-height: 100vh;
            background-color: var(--background-color);
        }

        .header {
            background: white;
            box-shadow: var(--card-shadow);
            padding: 15px 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .main-content {
            max-width: 1200px;
            margin: 80px auto 0;
            padding: 20px;
        }

        .upload-area {
            position: relative;
            border: 2px dashed #dcdfe6;
            border-radius: 8px;
            transition: all 0.3s;
            padding: 20px;
            background: white;
        }

        .upload-area.drag-over {
            border-color: var(--primary-color);
            background-color: rgba(64, 158, 255, 0.1);
        }

        .upload-area .el-upload {
            width: 100%;
        }

        .upload-area .el-upload-dragger {
            width: 100%;
            border: none;
            background: transparent;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .image-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: var(--card-shadow);
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        .image-info {
            padding: 15px;
        }

        .image-info .el-button {
            width: 100%;
            margin-top: 10px;
        }

        .annotation-dialog .el-dialog__body {
            padding: 30px;
        }

        .el-pagination {
            margin-top: 30px;
            text-align: center;
            padding: 20px 0;
        }

        /* 标签样式 */
        .image-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .image-tag {
            background: #f0f2f5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        /* 添加上传相关样式 */
        .upload-progress {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }

        .progress-item {
            margin-bottom: 15px;
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .filename {
            color: #606266;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 80%;
        }

        .progress-text {
            color: #909399;
            font-size: 14px;
        }

        .upload-area .el-upload-dragger {
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-area .el-upload {
            width: 100%;
        }

        .upload-area .el-upload-dragger:hover {
            border-color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .file-browser {
            height: 60vh;
            display: flex;
            flex-direction: column;
        }

        .file-browser-header {
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .file-browser-header h3 {
            margin: 0;
            font-size: 16px;
            color: #303133;
        }

        .file-browser-actions {
            display: flex;
            gap: 8px;
        }

        .file-browser-actions .el-button {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-browser-actions .el-button .el-icon {
            margin-right: 4px;
        }

        .file-path-breadcrumb {
            margin: 15px 0;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .file-path-breadcrumb .el-breadcrumb__item {
            display: flex;
            align-items: center;
        }

        .file-path-breadcrumb .el-breadcrumb__item:hover {
            color: var(--primary-color);
        }

        .file-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--card-shadow);
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .file-item:hover {
            background: #f5f7fa;
        }

        .file-item .el-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .file-browser {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .file-browser-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-browser-header h3 {
            margin: 0;
            color: #303133;
        }

        .file-path-breadcrumb {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .file-list {
            flex: 1;
            overflow: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .file-item:hover {
            color: var(--primary-color);
        }

        .upload-section {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .upload-area {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
        }

        .file-browser-actions {
            display: flex;
            gap: 8px;
        }

        .file-browser-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .el-button-group .el-button {
            margin-right: 0;
        }

        .el-icon {
            vertical-align: middle;
        }

        .el-breadcrumb__item {
            cursor: pointer;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .preview-item {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .preview-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }

        .preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .preview-info {
            padding: 10px;
            background: #f8f9fa;
        }

        .preview-name {
            display: block;
            font-size: 14px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-size {
            display: block;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .no-images {
            text-align: center;
            padding: 40px;
            color: #909399;
            font-size: 14px;
        }

        /* 修改布局相关样式 */
        .content-layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .file-browser {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .file-browser-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-path-breadcrumb {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .file-list {
            flex: 1;
            overflow: auto;
        }

        /* 表格相关样式 */
        .el-table {
            --el-table-border-color: #ebeef5;
            --el-table-header-background-color: #f5f7fa;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 0;
        }

        .file-item:hover {
            color: var(--primary-color);
        }

        .file-item .el-icon {
            font-size: 16px;
        }

        /* 确保表格内容垂直居中 */
        .el-table .cell {
            display: flex;
            align-items: center;
        }

        /* 按钮组样式 */
        .file-browser-actions .el-button-group {
            display: flex;
            gap: 4px;
        }

        .file-browser-actions .el-button {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* 调整表格列样式 */
        .el-table .cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .el-table .file-size-column {
            text-align: right;
        }

        .el-table .date-column {
            text-align: center;
        }

        .el-dialog__body {
            padding: 0;
        }

        /* 添加预览对话框相关样式 */
        .preview-dialog .el-dialog__body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .preview-item {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            background: white;
        }

        .preview-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow);
        }

        .preview-image-wrapper {
            position: relative;
            padding-top: 75%; /* 4:3 比例 */
            overflow: hidden;
        }

        .preview-image-wrapper img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .preview-info {
            padding: 10px;
            background: #f8f9fa;
        }

        .preview-name {
            display: block;
            font-size: 14px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-size {
            display: block;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .no-images {
            padding: 40px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <header class="header">
                <div class="header-content">
                    <h1>图像生成模型训练平台</h1>
                </div>
            </header>

            <main class="main-content">
                <!-- 修改文件列表部分的布局 -->
                <div class="content-layout">
                    <!-- 文件浏览器 -->
                    <div class="file-browser">
                        <div class="file-browser-header">
                            <h3>文件浏览器</h3>
                            <div class="file-browser-actions">
                                <el-button-group>
                                    <el-tooltip content="返回根目录" placement="top">
                                        <el-button size="small" @click="navigateTo('')">
                                            <el-icon><home-filled /></el-icon>
                                            主目录
                                        </el-button>
                                    </el-tooltip>
                                    <el-tooltip content="刷新列表" placement="top">
                                        <el-button size="small" @click="refreshFiles">
                                            <el-icon><refresh /></el-icon>
                                            刷新
                                        </el-button>
                                    </el-tooltip>
                                </el-button-group>
                            </div>
                        </div>

                        <div class="file-path-breadcrumb">
                            <el-breadcrumb separator="/">
                                <el-breadcrumb-item @click="navigateTo('')">根目录</el-breadcrumb-item>
                                <el-breadcrumb-item 
                                    v-for="(part, index) in currentPathParts" 
                                    :key="index"
                                    @click="navigateTo(getCurrentPathUpTo(index))">
                                    {{ part }}
                                </el-breadcrumb-item>
                            </el-breadcrumb>
                        </div>

                        <div class="file-list" v-loading="fileLoading">
                            <el-table :data="fileList" style="width: 100%">
                                <el-table-column label="名称" min-width="200">
                                    <template #default="scope">
                                        <div class="file-item" @click="handleFileClick(scope.row)">
                                            <el-icon>
                                                <folder v-if="scope.row.type === 'directory'" />
                                                <document v-else />
                                            </el-icon>
                                            <span>{{ scope.row.name }}</span>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="大小" width="100" align="right">
                                    <template #default="scope">
                                        {{ formatFileSize(scope.row.size) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="修改时间" width="160" align="center">
                                    <template #default="scope">
                                        {{ formatDateTime(scope.row.modified) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="100" align="center">
                                    <template #default="scope">
                                        <el-button 
                                            v-if="scope.row.type === 'directory'"
                                            link 
                                            type="primary" 
                                            @click.stop="enterTrainingWorkspace(scope.row)">
                                            训练
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>

                    <!-- 右侧上传区域 -->
                    <div class="upload-section">
                        <div class="upload-area" 
                             :class="{ 'drag-over': isDragging }"
                             @dragover="handleDragOver"
                             @dragleave="handleDragLeave"
                             @drop="handleDrop">
                            <el-upload
                                ref="uploadRef"
                                action="/api/upload-images"
                                multiple
                                drag
                                :on-progress="handleProgress"
                                :on-success="handleUploadSuccess"
                                :on-error="handleUploadError"
                                :before-upload="beforeUpload"
                                :file-list="uploadFiles"
                                :accept="acceptTypes"
                                name="files"
                                :headers="{'Accept': 'application/json'}"
                                :auto-upload="true"
                                :show-file-list="false"
                                :multiple-limit="10">
                                <el-icon style="font-size: 48px; color: #909399; margin-bottom: 10px;">
                                    <upload-filled />
                                </el-icon>
                                <div class="el-upload__text">
                                    <h3>拖拽文件到此处或 <em>点击上传</em></h3>
                                    <p style="color: #909399; margin: 10px 0;">支持图片格式和压缩包格式</p>
                                </div>
                                <template #tip>
                                    <div class="el-upload__tip">
                                        支持上传图片或压缩包格式，单个文件最大 500MB
                                    </div>
                                </template>
                            </el-upload>
                        </div>

                        <!-- 上传进度显示 -->
                        <div v-if="uploadingFiles.length > 0" class="upload-progress">
                            <div v-for="file in uploadingFiles" 
                                 :key="file.uid" 
                                 class="progress-item">
                                <div class="progress-info">
                                    <span class="filename">{{ file.name }}</span>
                                    <span class="progress-text">{{ file.percentage }}%</span>
                                </div>
                                <el-progress 
                                    :percentage="file.percentage"
                                    :status="file.status === 'success' ? 'success' : file.status === 'error' ? 'exception' : ''"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 修改预览对话框 -->
    <el-dialog
        v-model="previewDialogVisible"
        :title="`文件夹预览 (${previewImages.length} 个图片)`"
        :width="previewDialogStyle.width"
        :destroy-on-close="true"
        class="preview-dialog">
        <div v-if="previewImages.length > 0" class="preview-grid">
            <div v-for="image in previewImages" 
                 :key="image.path" 
                 class="preview-item">
                <div class="preview-image-wrapper">
                    <img :src="image.url" 
                         :alt="image.name"
                         @error="handleImageError"
                         @click="window.open(image.url, '_blank')"
                         :title="image.name">
                </div>
                <div class="preview-info">
                    <span class="preview-name" :title="image.name">{{ image.name }}</span>
                    <span class="preview-size">{{ formatFileSize(image.size) }}</span>
                </div>
            </div>
        </div>
        <div v-else class="no-images">
            <el-empty description="该文件夹中没有图片" />
        </div>
        <template #footer>
            <div class="dialog-footer">
                <el-button @click="previewDialogVisible = false">关闭</el-button>
            </div>
        </template>
    </el-dialog>

    <script>
        window.ELEMENT_PLUS_DEVTOOLS = false;

        const { createApp, ref, onMounted, onUnmounted, computed } = Vue;

        const { 
            HomeFilled, 
            Refresh,
            Upload,
            UploadFilled,
            Document,
            Folder
        } = ElementPlusIconsVue;

        const app = createApp({
            setup() {
                const images = ref([]);
                const total = ref(0);
                const pageSize = ref(20);
                const currentPage = ref(1);
                const dialogVisible = ref(false);
                const currentImage = ref(null);
                const isLoading = ref(false);
                const isSaving = ref(false);
                const isTraining = ref(false);

                const annotationForm = ref({
                    prompt: '',
                    negative_prompt: '',
                    labels: []
                });

                const commonTags = ref(['人物', '风景', '动物', '建筑', '艺术', '插画', '写实', '抽象']);

                const uploadFiles = ref([]);
                const uploadingFiles = ref([]);
                const acceptTypes = ref('.jpg,.jpeg,.png,.gif,.zip,.rar,.7z');

                const ws = ref(null);
                const clientId = ref(`client_${Date.now()}`);
                const trainingProgress = ref({});

                const fileBrowserVisible = ref(false);
                const fileList = ref([]);
                const fileLoading = ref(false);
                const currentPath = ref('');

                const folderInput = ref(null);

                const isDragging = ref(false);

                const previewDialogVisible = ref(false);
                const previewImages = ref([]);

                const uploadRef = ref(null);

                const uploadQueueVisible = ref(false);
                const uploadTasks = ref([]);
                const uploadQueue = ref([]);
                const isUploading = ref(false);
                const MAX_CONCURRENT_UPLOADS = 3; // 最大同时上传数

                const globalUploadVisible = ref(false);
                const globalUploadStatus = ref({
                    active: [],
                    history: []
                });

                // 计算属性
                const totalTasks = computed(() => uploadTasks.value.length);
                const waitingTasks = computed(() => uploadTasks.value.filter(t => t.status === 'waiting').length);
                const completedTasks = computed(() => uploadTasks.value.filter(t => ['success', 'error'].includes(t.status)).length);
                const uploadingTasks = computed(() => uploadTasks.value.filter(t => t.status === 'uploading').length);
                const activeTasks = computed(() => globalUploadStatus.value.active);
                const uploadHistory = computed(() => globalUploadStatus.value.history);
                const totalActiveTasks = computed(() => activeTasks.value.length);

                const formatSpeed = (speed) => {
                    if (!speed) return '0 KB/s';
                    return `${(speed / 1024).toFixed(1)} KB/s`;
                };

                const formatTime = (seconds) => {
                    if (!seconds) return '--';
                    return `${Math.ceil(seconds)}s`;
                };

                const formatDate = (dateStr) => {
                    return new Date(dateStr).toLocaleString();
                };

                const clearUploadList = () => {
                    if (uploadRef.value) {
                        uploadRef.value.clearFiles();
                    }
                    uploadFiles.value = [];
                    uploadingFiles.value = [];
                };

                const fetchImages = async (page = 1) => {
                    isLoading.value = true;
                    try {
                        const response = await fetch(`/api/images?page=${page}&page_size=${pageSize.value}`);
                        const data = await response.json();
                        images.value = data.images;
                        total.value = data.total;
                    } catch (error) {
                        console.error('获取图片列表失败:', error);
                        ElMessage.error('获取图片列表失败');
                    } finally {
                        isLoading.value = false;
                    }
                };

                const handleUploadSuccess = (response, file, fileList) => {
                    console.log('Upload success:', response);
                    ElMessage.success('上传成功');
                    
                    // 更新进度显示
                    const uploadedFile = uploadingFiles.value.find(f => f.uid === file.uid);
                    if (uploadedFile) {
                        uploadedFile.percentage = 100;
                        uploadedFile.status = 'success';
                    }
                    
                    // 延迟清除进度显示
                    setTimeout(() => {
                        uploadingFiles.value = uploadingFiles.value.filter(f => f.uid !== file.uid);
                    }, 3000);
                    
                    // 刷新图片列表
                    fetchImages(currentPage.value);
                    
                    // 清除上传列表
                    if (uploadRef.value) {
                        uploadRef.value.clearFiles();
                    }
                    
                    // 更新队列状态
                    processUploadQueue();
                };

                const handleUploadError = (error, file, fileList) => {
                    console.error('Upload error:', error);
                    ElMessage.error('上传失败');
                    // 更新失败状态
                    const failedFile = uploadingFiles.value.find(f => f.uid === file.uid);
                    if (failedFile) {
                        failedFile.status = 'error';
                        // 3秒后移除失败状态
                        setTimeout(() => {
                            uploadingFiles.value = uploadingFiles.value.filter(f => f.uid !== file.uid);
                        }, 3000);
                    }
                    // 从上传列表中移除
                    uploadFiles.value = uploadFiles.value.filter(f => f.uid !== file.uid);
                    
                    // 更新队列状态
                    processUploadQueue();
                };

                const handlePageChange = (page) => {
                    currentPage.value = page;
                    fetchImages(page);
                };

                const showAnnotationDialog = (image) => {
                    currentImage.value = image;
                    if (image.annotations) {
                        annotationForm.value = {
                            prompt: image.annotations.prompt || '',
                            negative_prompt: image.annotations.negative_prompt || '',
                            labels: image.annotations.labels || []
                        };
                    } else {
                        annotationForm.value = {
                            prompt: '',
                            negative_prompt: '',
                            labels: []
                        };
                    }
                    dialogVisible.value = true;
                };

                const saveAnnotation = async () => {
                    isSaving.value = true;
                    try {
                        const formData = new FormData();
                        formData.append('image_id', currentImage.value.image_id);
                        formData.append('labels', JSON.stringify(annotationForm.value.labels));
                        formData.append('prompt', annotationForm.value.prompt);
                        formData.append('negative_prompt', annotationForm.value.negative_prompt);

                        const response = await fetch('/api/save-annotation', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            ElMessage.success('标注保存成功');
                            dialogVisible.value = false;
                            fetchImages(currentPage.value);
                        } else {
                            throw new Error('保存失败');
                        }
                    } catch (error) {
                        console.error('保存标注失败:', error);
                        ElMessage.error('保存标注失败');
                    } finally {
                        isSaving.value = false;
                    }
                };

                const connectWebSocket = () => {
                    const clientId = `client_${Date.now()}`;
                    const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/${clientId}`;
                    
                    try {
                        ws.value = new WebSocket(wsUrl);
                        
                        ws.value.onopen = () => {
                            console.log('WebSocket connected');
                        };
                        
                        ws.value.onclose = () => {
                            console.log('WebSocket disconnected');
                            // 3秒后尝试重连
                            setTimeout(connectWebSocket, 3000);
                        };
                        
                        ws.value.onerror = (error) => {
                            console.error('WebSocket error:', error);
                        };
                        
                        ws.value.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                handleWebSocketMessage(data);
                            } catch (error) {
                                console.error('Error parsing WebSocket message:', error);
                            }
                        };
                    } catch (error) {
                        console.error('Error connecting to WebSocket:', error);
                        // 3秒后尝试重连
                        setTimeout(connectWebSocket, 3000);
                    }
                };

                const startTraining = async () => {
                    isTraining.value = true;
                    try {
                        const response = await fetch('/api/start-training', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                model_name: 'default_model',
                                dataset_id: 1,
                                params: {}
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            // 订阅训练进度
                            ws.value.send(JSON.stringify({
                                type: 'subscribe_training',
                                task_id: data.task_id
                            }));
                            ElMessage.success('训练任务已启动');
                        } else {
                            throw new Error('启动训练失败');
                        }
                    } catch (error) {
                        console.error('启动训练失败:', error);
                        ElMessage.error('启动训练失败');
                    } finally {
                        isTraining.value = false;
                    }
                };

                // 更新训练进度显示
                const updateTrainingProgress = (data) => {
                    if (data.status === 'completed') {
                        ElMessage.success('训练完成！');
                    } else if (data.status === 'failed') {
                        ElMessage.error('训练失败！');
                    }
                    // 更新进度条等UI元素
                };

                // 修改文件大小限制
                const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500MB

                // 修改文件上传前的验证
                const beforeUpload = (file) => {
                    // 检查文件类型
                    const allowedTypes = [
                        'image/jpeg',
                        'image/png',
                        'image/gif',
                        'application/zip',
                        'application/x-rar-compressed',
                        'application/x-7z-compressed'
                    ];
                    
                    const isAllowedType = allowedTypes.includes(file.type) || 
                                         file.name.toLowerCase().endsWith('.zip') ||
                                         file.name.toLowerCase().endsWith('.rar') ||
                                         file.name.toLowerCase().endsWith('.7z');
                    
                    if (!isAllowedType) {
                        ElMessage.error('只能上传图片或压缩包格式的文件!');
                        return false;
                    }
                    
                    // 检查文件大小（500MB）
                    const isLtMaxSize = file.size <= MAX_FILE_SIZE;
                    if (!isLtMaxSize) {
                        ElMessage.error('单个文件大小不能超过 500MB!');
                        return false;
                    }
                    
                    return true;
                };

                // 处理上传进度
                const handleProgress = (event, file, fileList) => {
                    console.log('Upload progress:', event.percent, file.name);
                    const existingFile = uploadingFiles.value.find(f => f.uid === file.uid);
                    if (existingFile) {
                        existingFile.percentage = Math.round(event.percent);
                    } else {
                        uploadingFiles.value.push({
                            uid: file.uid,
                            name: file.name,
                            percentage: Math.round(event.percent),
                            status: 'uploading'
                        });
                    }
                };

                const showFileBrowser = async () => {
                    fileBrowserVisible.value = true;
                    await loadFileList();
                };

                const loadFileList = async (path) => {
                    fileLoading.value = true;
                    try {
                        const response = await fetch(`/api/workspace/images/${encodeURIComponent(path || '')}`);
                        if (response.ok) {
                            const data = await response.json();
                            fileList.value = data.images;
                            // 不需要额外的类型映射，因为后端已经提供了正确的类型
                        } else {
                            throw new Error('加载文件列表失败');
                        }
                    } catch (error) {
                        console.error('加载文件列表失败:', error);
                        ElMessage.error('加载文件列表失败');
                    } finally {
                        fileLoading.value = false;
                    }
                };

                const handleFileClick = (file) => {
                    if (file.type === 'directory') {
                        // 如果是文件夹，则导航到该文件夹
                        navigateTo(file.path);
                    } else {
                        // 如果是文件，可以预览或其他操作
                        // 这里可以添加文件预览逻辑
                        window.open(file.url, '_blank');
                    }
                };

                const navigateTo = async (path) => {
                    try {
                        currentPath.value = path;
                        await loadFileList(path);
                    } catch (error) {
                        console.error('导航失败:', error);
                        ElMessage.error('导航失败');
                    }
                };

                const getCurrentPathUpTo = (index) => {
                    return currentPathParts.value.slice(0, index + 1).join('/');
                };

                const downloadFile = (file) => {
                    const link = document.createElement('a');
                    link.href = `/static/${file.path}`;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                const triggerFolderUpload = () => {
                    folderInput.value.click();
                };

                const handleFolderSelect = async (event) => {
                    const files = Array.from(event.target.files);
                    if (files.length === 0) return;

                    // 创建一个 FormData 对象来保存所有文件它们的路径
                    const formData = new FormData();
                    
                    // 添所有文件到 FormData，包括它们的相对路径
                    files.forEach(file => {
                        // 获取文件的相对路径
                        const relativePath = file.webkitRelativePath;
                        formData.append('files', file);
                        formData.append('paths', relativePath);
                    });

                    try {
                        const response = await fetch('/api/upload-folder', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            ElMessage.success('文件夹上传成功');
                            // 刷新文件列表
                            loadFileList(currentPath.value);
                        } else {
                            throw new Error('上传失败');
                        }
                    } catch (error) {
                        console.error('文件夹上传失败:', error);
                        ElMessage.error('文件夹上传失败');
                    }
                    
                    // 清除input的值允许重上传相同的文件
                    event.target.value = '';
                };

                const handleDragOver = (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    // 只有当拖拽的是文件时才显示拖拽状态
                    if (event.dataTransfer.types.includes('Files')) {
                        isDragging.value = true;
                    }
                };

                const handleDragLeave = (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    // 确保鼠标真的离开了元素而不是进入了子元素
                    const rect = event.target.getBoundingClientRect();
                    const x = event.clientX;
                    const y = event.clientY;
                    if (x <= rect.left || x >= rect.right || y <= rect.top || y >= rect.bottom) {
                        isDragging.value = false;
                    }
                };

                const handleDrop = async (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    isDragging.value = false;
                    
                    const files = Array.from(event.dataTransfer.files);
                    if (files.length === 0) return;

                    // 清除之前的上传状态
                    clearUploadList();

                    // 过滤文件类型
                    const validFiles = files.filter(file => {
                        const isValidType = beforeUpload(file);
                        if (!isValidType) {
                            console.log(`Skipping invalid file: ${file.name}`);
                        }
                        return isValidType;
                    });

                    if (validFiles.length === 0) {
                        ElMessage.warning('没有找到有效的文件');
                        return;
                    }

                    ElMessage.info(`正在上传 ${validFiles.length} 个文件...`);
                    
                    const formData = new FormData();
                    validFiles.forEach(file => {
                        formData.append('files', file);
                        // 添加到上传进度跟踪
                        uploadingFiles.value.push({
                            uid: Math.random().toString(36).substring(7),
                            name: file.name,
                            percentage: 0,
                            status: 'uploading'
                        });
                    });

                    // 检查文件总大小
                    const totalSize = validFiles.reduce((sum, file) => sum + file.size, 0);
                    const MAX_TOTAL_SIZE = 2 * 1024 * 1024 * 1024; // 2GB
                    
                    if (totalSize > MAX_TOTAL_SIZE) {
                        ElMessage.error('文件总大小不能超过 2GB!');
                        return;
                    }

                    try {
                        const response = await fetch('/api/upload-images', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Upload successful:', result);
                            ElMessage.success('文件上传成功');
                            // 更新所有文件状态为成功
                            uploadingFiles.value.forEach(file => {
                                file.percentage = 100;
                                file.status = 'success';
                            });
                            // 延迟清除进度显示
                            setTimeout(() => {
                                uploadingFiles.value = [];
                            }, 3000);
                            // 刷新图片列表
                            fetchImages(currentPage.value);
                        } else {
                            throw new Error(await response.text());
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        ElMessage.error(`上传失败: ${error.message}`);
                        // 更新所有文件状态为失败
                        uploadingFiles.value.forEach(file => {
                            file.status = 'error';
                        });
                    } finally {
                        // 确保清除上传列表
                        clearUploadList();
                    }
                };

                const previewFolder = async (folder) => {
                    console.log('预览文件夹:', folder);  // 调试信息
                    previewDialogVisible.value = false;  // 先重置对话框状态
                    previewImages.value = [];  // 清空之前的图片
                    
                    try {
                        const folderPath = folder.path.endsWith('/') ? folder.path.slice(0, -1) : folder.path;
                        const url = `/api/workspace/images/${encodeURIComponent(folderPath)}`;
                        console.log('请求URL:', url);
                        
                        const response = await fetch(url);
                        const data = await response.json();
                        console.log('预览数据:', data);
                        
                        if (response.ok) {
                            // 过滤并处理图片
                            previewImages.value = data.images
                                .filter(item => item.type === 'file' && item.name.toLowerCase().match(/\.(jpg|jpeg|png|gif)$/))
                                .map(item => ({
                                    ...item,
                                    url: item.url.startsWith('/') ? item.url : `/${item.url}`
                                }));
                            
                            console.log('过滤后的图片:', previewImages.value);
                            
                            if (previewImages.value.length > 0) {
                                previewDialogVisible.value = true;  // 只有在有图片时才显示对话框
                            } else {
                                ElMessage.info('该文件夹中没有图片文件');
                            }
                        } else {
                            throw new Error(data.detail || '获取预览失败');
                        }
                    } catch (error) {
                        console.error('预览错误:', error);
                        ElMessage.error(`获取文件夹预览失败: ${error.message}`);
                    }
                };

                // 修改预览对话框的样式
                const previewDialogStyle = {
                    width: '80%',
                    maxWidth: '1200px'
                };

                // 添加任务到上传队列
                const addToUploadQueue = (files) => {
                    const tasks = files.map(file => ({
                        id: Math.random().toString(36).substr(2, 9),
                        file,
                        name: file.name,
                        size: file.size,
                        progress: 0,
                        status: 'waiting',
                        retries: 0,
                        maxRetries: 3
                    }));
                    
                    uploadTasks.value.push(...tasks);
                    uploadQueue.value.push(...tasks);
                    processUploadQueue();
                };

                // 处理上传队列
                const processUploadQueue = async () => {
                    if (isUploading.value) return;
                    
                    while (uploadQueue.value.length > 0 && 
                           activeTasks.value < MAX_CONCURRENT_UPLOADS) {
                        const task = uploadQueue.value.shift();
                        if (task) {
                            await uploadFile(task);
                        }
                    }
                };

                // 上传单个文件
                const uploadFile = async (task) => {
                    task.status = 'uploading';
                    isUploading.value = true;

                    const formData = new FormData();
                    formData.append('files', task.file);

                    try {
                        const response = await fetch('/api/upload-images', {
                            method: 'POST',
                            body: formData,
                            onUploadProgress: (progressEvent) => {
                                task.progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            }
                        });

                        if (response.ok) {
                            task.status = 'success';
                            task.progress = 100;
                            ElMessage.success(`${task.name} 上传成功`);
                        } else {
                            throw new Error(await response.text());
                        }
                    } catch (error) {
                        console.error(`Upload failed for ${task.name}:`, error);
                        task.status = 'error';
                        task.error = error.message;
                        ElMessage.error(`${task.name} 上传失败`);
                    } finally {
                        isUploading.value = false;
                        processUploadQueue();
                    }
                };

                // 重试失败的任务
                const retryTask = (task) => {
                    if (task.retries < task.maxRetries) {
                        task.retries++;
                        task.status = 'waiting';
                        task.progress = 0;
                        uploadQueue.value.push(task);
                        processUploadQueue();
                    }
                };

                // 清除已完成的任务
                const clearCompletedTasks = () => {
                    uploadTasks.value = uploadTasks.value.filter(
                        task => !['success', 'error'].includes(task.status)
                    );
                };

                const handleWebSocketMessage = (data) => {
                    if (data.type === 'upload_status') {
                        globalUploadStatus.value = data.data;
                    }
                    // ... 处理其他消息类型
                };

                // 添加刷新方法
                const refreshFiles = () => {
                    loadFileList(currentPath.value);
                };

                // 计算当前路径的各个部分
                const currentPathParts = computed(() => {
                    if (!currentPath.value) return [];
                    return currentPath.value.split('/').filter(Boolean);
                });

                // 格式化文件大小
                const formatFileSize = (size) => {
                    if (typeof size === 'string') return size; // 如果已经是格式化的字符串（如"文件夹"）
                    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                    let bytes = Number(size);
                    let unitIndex = 0;
                    
                    while (bytes >= 1024 && unitIndex < units.length - 1) {
                        bytes /= 1024;
                        unitIndex++;
                    }
                    
                    return `${bytes.toFixed(1)} ${units[unitIndex]}`;
                };

                // 格式化时间
                const formatDateTime = (dateStr) => {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                };

                // 添加图片加载错误处理
                const handleImageError = (e) => {
                    console.error('图片加载失败:', e.target.src);
                    e.target.src = ''; // 可以设置一个默认的错误图片
                    ElMessage.error('图片加载失败');
                };

                const enterTrainingWorkspace = (folder) => {
                    // 使用文件夹路径导航到训练工作区
                    const workspacePath = `/workspace/${encodeURIComponent(folder.path)}`;
                    window.location.href = workspacePath;
                };

                onMounted(() => {
                    fetchImages();
                    connectWebSocket();
                    loadFileList(''); // 加载根目录文件列表
                });

                onUnmounted(() => {
                    if (ws.value) {
                        ws.value.close();
                    }
                });

                return {
                    images,
                    total,
                    pageSize,
                    dialogVisible,
                    annotationForm,
                    commonTags,
                    isLoading,
                    isSaving,
                    isTraining,
                    handleUploadSuccess,
                    handleUploadError,
                    handlePageChange,
                    showAnnotationDialog,
                    saveAnnotation,
                    startTraining,
                    uploadFiles,
                    uploadingFiles,
                    acceptTypes,
                    beforeUpload,
                    handleProgress,
                    fileBrowserVisible,
                    fileList,
                    fileLoading,
                    currentPath,
                    showFileBrowser,
                    handleFileClick,
                    navigateTo,
                    getCurrentPathUpTo,
                    downloadFile,
                    folderInput,
                    triggerFolderUpload,
                    handleFolderSelect,
                    handleDragOver,
                    handleDragLeave,
                    handleDrop,
                    isDragging,
                    previewDialogVisible,
                    previewImages,
                    previewFolder,
                    uploadRef,
                    clearUploadList,
                    uploadQueueVisible,
                    uploadTasks,
                    totalTasks,
                    waitingTasks,
                    completedTasks,
                    uploadingTasks,
                    addToUploadQueue,
                    retryTask,
                    clearCompletedTasks,
                    globalUploadVisible,
                    activeTasks,
                    uploadHistory,
                    totalActiveTasks,
                    formatSpeed,
                    formatTime,
                    formatDate,
                    HomeFilled,
                    Refresh,
                    Upload,
                    UploadFilled,
                    Document,
                    Folder,
                    refreshFiles,
                    currentPathParts,
                    loadFileList,
                    formatFileSize,
                    formatDateTime,
                    handleImageError,
                    previewDialogStyle,
                    enterTrainingWorkspace,
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');

        // 注册图标组件
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component);
        }
    </script>
</body>
</html> 